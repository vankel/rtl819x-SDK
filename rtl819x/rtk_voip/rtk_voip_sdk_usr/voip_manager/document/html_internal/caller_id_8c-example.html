<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIP Interface: Main Page2</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head>
<img src=realtek.jpg>
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">caller_id.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Example for caller id operation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="voip__manager_8h.html" title="VoIP control API.">voip_manager.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> ShowUsage(<span class="keywordtype">char</span> *cmd)</div>
<div class="line">{</div>
<div class="line">    printf(</div>
<div class="line">        <span class="stringliteral">&quot;usage: %s &lt;mode=0&gt; &lt;caller_id&gt; &lt;DTMF mode&gt; &lt;DTMF duration&gt; &lt;DTMF intergigit pause duration&gt; \n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;       %s &lt;mode=1&gt; &lt;caller_id&gt; &lt;FSK area&gt;  &lt;FSK_type&gt; \n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;       %s &lt;mode=2&gt; [test_set]\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - mode =&gt; 0 is DTMF, 1 is FSK, 2 is DTMF predefined verfication\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - caller_id =&gt; caller id string\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK area[2:0] =&gt; 0 BELLCORE, 1: ETSI, 2: BT, 3: NTT\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK area[bit8]=&gt; Auto Ring, 0: disable, 1: enable\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK area[bit7]=&gt; FSK date &amp; time sync\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK area[bit6]=&gt; reverse polarity before caller id (For FSK)\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK area[bit5]=&gt; short ring before caller id (For FSK)\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK area[bit4]=&gt; dual alert tone before caller id (For FSK)\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK area[bit3]=&gt; caller id Prior Ring (FSK &amp; DTMF)\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - FSK type =&gt; 1 is type-I, 2 is type-II\n&quot;</span>\</div>
<div class="line">        <span class="stringliteral">&quot;  - DTMF mode[1:0]=&gt; Start digit, 0:A, 1:B, 2:C, 3:D\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - DTMF mode[3:2]=&gt; End digit, 0:A, 1:B, 2:C, 3:D\n&quot;</span>  \</div>
<div class="line">        <span class="stringliteral">&quot;  - DTMF mode[4]=&gt; Auto start/end digit send, 0:non-auto mode 1:auto mode\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;   (non-auto mode: DSP send caller ID string only. If caller ID need start/end digits, developer should add them to caller ID strings.)\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - DTMF mode[5]=&gt; Auto Ring, 0: disable, 1: enable\n&quot;</span> \</div>
<div class="line">        <span class="stringliteral">&quot;  - DTMF mode[6]=&gt; Before 1st Ring, 0: after 1st Ring, 1: before 1st Ring.\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  - DTMF mode[7]==&gt; Auto SLIC action, 0: Disable, - 1: Enable.\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;                    SLIC action, such as SLIC hook statue check, line polarity change (not include SLIC Ringing)\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  - test_set[0] ==&gt; test items are auto ring, and auto SLIC action\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  - test_set[1] ==&gt; test items are NO auto ring, and NO auto SLIC action\n&quot;</span></div>
<div class="line">        , cmd, cmd, cmd);</div>
<div class="line">    exit(0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> CID_DTMF_predefined_verification( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> test_set );</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mode, dtmf_mode, dtmf_mode2, digit_on, digit_pause, fsk_type, fsk_area;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> test_set = 0xFFFFFF;</div>
<div class="line">    <a class="code" href="voip__params_8h.html#a0c013175874f2e4ccfc7d2697d98f94d">DTMF_DIGIT</a> dtmf_start, dtmf_end;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (argc &lt; 2)</div>
<div class="line">    {</div>
<div class="line">        ShowUsage(argv[0]);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    mode = atoi(argv[1]);</div>
<div class="line">    <span class="keywordflow">switch</span> (mode)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> 0:</div>
<div class="line">        <span class="keywordflow">if</span>( argc &lt; 6 )</div>
<div class="line">            <span class="keywordflow">goto</span> label_show_usage;</div>
<div class="line">            </div>
<div class="line">        dtmf_mode = atoi(argv[3]);</div>
<div class="line">        digit_on = atoi(argv[4]);</div>
<div class="line">        digit_pause = atoi(argv[5]);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// first ring by AP </span></div>
<div class="line">        <span class="keywordflow">if</span>( ( dtmf_mode &amp; 0x20 ) == 0 &amp;&amp; ( dtmf_mode &amp; 0x40 ) == 0 ) {</div>
<div class="line">            <span class="comment">// not auto ring, and DTMF after ring </span></div>
<div class="line">            <a name="a0"></a><a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>( 0, 1 );</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// wait ring complete </span></div>
<div class="line">            usleep( 2 * 1000 * 1000 );  <span class="comment">// simple implement: delay 2 seconds </span></div>
<div class="line">            </div>
<div class="line">            <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>( 0, 0 );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        dtmf_start = DTMF_DIGIT_A + (dtmf_mode&amp;0x3);</div>
<div class="line">        dtmf_end = DTMF_DIGIT_A + ((dtmf_mode&gt;&gt;2)&amp;0x3);</div>
<div class="line">        dtmf_mode2 = (dtmf_mode&amp;0xf0)&gt;&gt;4;</div>
<div class="line"></div>
<div class="line">        <a name="a1"></a><a class="code" href="group__TAPI__DSP__CID__DTMF.html#ga852dec0700b0a22055ccc6d816b690b0" title="Set the parameters of DTMF Caller ID Generation.">rtk_SetDtmfCidParam</a>(0, dtmf_start, dtmf_end, dtmf_mode2, digit_on, digit_pause, 300, 300); <span class="comment">//pre_silence = 300ms, end_silence = 300ms</span></div>
<div class="line">        <a name="a2"></a><a class="code" href="group__TAPI__DSP__CID__DTMF.html#gac7f0c2f318e571a35bb896c0cf607a9c" title="Generate DTMF Caller ID.">rtk_GenDtmfCid</a>(0, argv[2]);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ring by AP</span></div>
<div class="line">        <span class="keywordflow">if</span>( ( dtmf_mode &amp; 0x20 ) == 0 ) {</div>
<div class="line">            <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>( 0, 1 );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 1:</div>
<div class="line">        <span class="keywordflow">if</span> (argc == 5)</div>
<div class="line">        {</div>
<div class="line">            fsk_area = atoi(argv[3]);</div>
<div class="line">            </div>
<div class="line">            <span class="comment">//rtk_SetCidFskGenMode(0, 1);</span></div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> ((fsk_area&amp;7) &gt; CID_DTMF)</div>
<div class="line">                printf(<span class="stringliteral">&quot;wrong FSK area =&gt; 0 BELLCORE, 1: ETSI, 2: BT, 3: NTT\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(atoi(argv[4])!= 1 &amp;&amp; atoi(argv[4])!= 2)</div>
<div class="line">                printf(<span class="stringliteral">&quot;wrong fsk type: should be type-I(1) or type-II(2)\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {   </div>
<div class="line">                fsk_type = atoi(argv[4])- 1 ;</div>
<div class="line">                <a name="a3"></a><a class="code" href="group__TAPI__DSP__CID__FSK.html#ga268000217281f9636bc5179561d8c1aa" title="Set the FSK Area.">rtk_SetFskArea</a>(0, fsk_area);</div>
<div class="line">                <a name="a4"></a><a class="code" href="group__TAPI__DSP__CID__FSK.html#gac8dd91003de0d7c50e371540e9d67dbb" title="FSK Caller ID Generation.">rtk_GenFskCid</a>(0, argv[2], (<span class="keywordtype">void</span> *) 0, (<span class="keywordtype">void</span> *) 0, fsk_type<span class="comment">/*FSK Type*/</span>); <span class="comment">// </span></div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">goto</span> label_show_usage;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 2:</div>
<div class="line">        <span class="keywordflow">if</span>( argc &gt;= 3 )</div>
<div class="line">            test_set = atoi(argv[2]);</div>
<div class="line">        CID_DTMF_predefined_verification( test_set );</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">label_show_usage:</div>
<div class="line">        ShowUsage(argv[0]);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// DTMF caller ID predefined test set (mode=2)</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    DTMF_DIGIT_a,</div>
<div class="line">    DTMF_DIGIT_b,</div>
<div class="line">    DTMF_DIGIT_c,</div>
<div class="line">    DTMF_DIGIT_d,</div>
<div class="line">} DTMF_DIGIT_t;</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keyword">struct </span>{</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bAutoDigit:    1;</div>
<div class="line">        DTMF_DIGIT_t nStartDigit:   2;</div>
<div class="line">        DTMF_DIGIT_t nEndDigit:     2;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bAutoRing:         1;</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bBeforeFirstRing:  1;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bAutoSlicAction:   1;</div>
<div class="line">    } mode;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">struct </span>{</div>
<div class="line">        uint32 on;      <span class="comment">// in unit of ms (suggest: 80ms)</span></div>
<div class="line">        uint32 pause;   <span class="comment">// in unit of ms (suggest: 80ms)</span></div>
<div class="line">    } duration;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">struct </span>{</div>
<div class="line">        uint32 pre;     <span class="comment">// in unit of ms (suggest: 300ms)</span></div>
<div class="line">        uint32 end;     <span class="comment">// in unit of ms (suggest: 300ms)</span></div>
<div class="line">    } silence;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">struct </span>{</div>
<div class="line">        <span class="keywordtype">char</span> <span class="keywordtype">string</span>[ 64 ];</div>
<div class="line">    } id;</div>
<div class="line">} CID_DTMF_verify_t;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> Run_CID_DTMF_verification( <span class="keyword">const</span> CID_DTMF_verify_t *pCIDDTMF )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dtmf_mode, dtmf_mode2;</div>
<div class="line">    <a class="code" href="voip__params_8h.html#adc20e233fff4ea8af423ffe7a8a1029d">VoipEventID</a> dsp_event;</div>
<div class="line">    <span class="keywordtype">char</span> log_cmd[ 256 ];</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> log_seq = 0;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> random;</div>
<div class="line">    <a class="code" href="voip__manager_8h.html#a9c42baa0355e143d84ed28c5b4609996">SLICEVENT</a> slic_event;</div>
<div class="line">    <span class="keyword">const</span> uint32 chid = 0;</div>
<div class="line">    <a class="code" href="voip__params_8h.html#a0c013175874f2e4ccfc7d2697d98f94d">DTMF_DIGIT</a> dtmf_start, dtmf_end;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span>( log_seq == 0 )</div>
<div class="line">        random = ( int )time( NULL );</div>
<div class="line"></div>
<div class="line">    <span class="comment">// parameters for DSP </span></div>
<div class="line">    dtmf_mode = 0;</div>
<div class="line">    dtmf_mode |= ( !pCIDDTMF -&gt;mode.bAutoDigit ? 0x00 : </div>
<div class="line">                        0x10 | ( pCIDDTMF -&gt;mode.nStartDigit ) | </div>
<div class="line">                                ( pCIDDTMF -&gt;mode.nEndDigit &lt;&lt; 2 ) );</div>
<div class="line">    dtmf_mode |= ( !pCIDDTMF -&gt;mode.bAutoRing ? 0x00 :</div>
<div class="line">                        0x20 | ( pCIDDTMF -&gt;mode.bBeforeFirstRing &lt;&lt; 6 ) );</div>
<div class="line">    dtmf_mode |= ( !pCIDDTMF -&gt;mode.bAutoSlicAction ? 0x00 : 0x80 );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Detail content </span></div>
<div class="line">    printf( <span class="stringliteral">&quot;Test setting:\n&quot;</span> );</div>
<div class="line">    printf( <span class="stringliteral">&quot;\tAuto digit: %s&quot;</span>, pCIDDTMF -&gt;mode.bAutoDigit ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span> );</div>
<div class="line">    <span class="keywordflow">if</span>( pCIDDTMF -&gt;mode.bAutoDigit ) {</div>
<div class="line">        printf( <span class="stringliteral">&quot;\t(Start=%c End=%c)\n&quot;</span>, <span class="charliteral">&#39;A&#39;</span> + pCIDDTMF -&gt;mode.nStartDigit,</div>
<div class="line">                                        <span class="charliteral">&#39;A&#39;</span> + pCIDDTMF -&gt;mode.nEndDigit );</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        printf( <span class="stringliteral">&quot;\n&quot;</span> );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;\tAuto ring: %s, DTMF &#39;%s&#39; first ring\n&quot;</span>, </div>
<div class="line">                        pCIDDTMF -&gt;mode.bAutoRing ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,</div>
<div class="line">                        pCIDDTMF -&gt;mode.bBeforeFirstRing ? <span class="stringliteral">&quot;before&quot;</span> : <span class="stringliteral">&quot;after&quot;</span> );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;\tAuto SLIC action: %s\n&quot;</span>, </div>
<div class="line">                        pCIDDTMF -&gt;mode.bAutoSlicAction ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span> );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;\tDuration: on=%u pause=%u (ms)\n&quot;</span>, </div>
<div class="line">                            pCIDDTMF -&gt;duration.on, pCIDDTMF -&gt;duration.pause );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;\tSilence: pre=%u end=%u (ms)\n&quot;</span>,</div>
<div class="line">                            pCIDDTMF -&gt;silence.pre, pCIDDTMF -&gt;silence.end );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;\tCaller ID: string=%s\n&quot;</span>, pCIDDTMF -&gt;<span class="keywordtype">id</span>.<span class="keywordtype">string</span> );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;\tdtmf_mode: %04X\n&quot;</span>, dtmf_mode );</div>
<div class="line">    </div>
<div class="line">    fflush( stdout );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;Press any key to start...\n&quot;</span> );</div>
<div class="line">    </div>
<div class="line">    getchar();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// start log </span></div>
<div class="line">    sprintf( log_cmd, <span class="stringliteral">&quot;cat /dev/voip/pcmtx0 &gt; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;pcmtx0_%02d_%04X-str%s-digit%d-%d-%d_&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;ring%d-before%d_&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;slic%d_&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;silence%d-%d_&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;duration%d-%d &amp;&quot;</span>, </div>
<div class="line">                        log_seq ++, random &amp; 0xFFFF, </div>
<div class="line">                        pCIDDTMF -&gt;<span class="keywordtype">id</span>.<span class="keywordtype">string</span>,</div>
<div class="line">                        pCIDDTMF -&gt;mode.bAutoDigit, </div>
<div class="line">                        pCIDDTMF -&gt;mode.nStartDigit,</div>
<div class="line">                        pCIDDTMF -&gt;mode.nEndDigit,</div>
<div class="line">                        </div>
<div class="line">                        pCIDDTMF -&gt;mode.bAutoRing, pCIDDTMF -&gt;mode.bBeforeFirstRing,</div>
<div class="line">                        </div>
<div class="line">                        pCIDDTMF -&gt;mode.bAutoSlicAction,</div>
<div class="line">                        </div>
<div class="line">                        pCIDDTMF -&gt;silence.pre, pCIDDTMF -&gt;silence.end,</div>
<div class="line">                        </div>
<div class="line">                        pCIDDTMF -&gt;duration.on, pCIDDTMF -&gt;duration.pause</div>
<div class="line">                        );</div>
<div class="line">    printf( <span class="stringliteral">&quot;start log - %s\n&quot;</span>, log_cmd );</div>
<div class="line">    system( log_cmd );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// flush all events fifo </span></div>
<div class="line">    <a name="a5"></a><a class="code" href="group__TAPI__PHONE__EVENT.html#ga360048e105becaf697d40d0319655470" title="Flush the VoIP kernel used FIFO.">rtk_SetFlushFifo</a>( chid );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// part 1: [ring] by AP (optional)</span></div>
<div class="line">    <span class="keywordflow">if</span>( !pCIDDTMF -&gt;mode.bAutoRing &amp;&amp; !pCIDDTMF -&gt;mode.bBeforeFirstRing ) {</div>
<div class="line">        <span class="comment">// not auto ring &amp;&amp; DTMF not before first ring </span></div>
<div class="line">        <span class="comment">// --&gt; ring by AP &amp;&amp; DTMF after first ring </span></div>
<div class="line">        <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>( chid, 1 );</div>
<div class="line">        printf( <span class="stringliteral">&quot;Turn on SLIC ring by AP\n&quot;</span> );</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// wait ring complete </span></div>
<div class="line">        usleep( 2 * 1000 * 1000 );  <span class="comment">// simple implement: delay 2 seconds </span></div>
<div class="line">        </div>
<div class="line">        <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>( chid, 0 );</div>
<div class="line">        printf( <span class="stringliteral">&quot;Turn off SLIC ring by AP\n&quot;</span> );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    dtmf_start = DTMF_DIGIT_A + (dtmf_mode&amp;0x3);</div>
<div class="line">    dtmf_end = DTMF_DIGIT_A + ((dtmf_mode&gt;&gt;2)&amp;0x3);</div>
<div class="line">    dtmf_mode2 = (dtmf_mode&amp;0xf0)&gt;&gt;4;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// part 2: silence pre + DTMF start + DTMF ID + DTMF end + silence end</span></div>
<div class="line">    <a class="code" href="group__TAPI__DSP__CID__DTMF.html#ga852dec0700b0a22055ccc6d816b690b0" title="Set the parameters of DTMF Caller ID Generation.">rtk_SetDtmfCidParam</a>(chid, dtmf_start, dtmf_end, dtmf_mode2, </div>
<div class="line">                            pCIDDTMF -&gt;duration.on, pCIDDTMF -&gt;duration.pause, </div>
<div class="line">                            pCIDDTMF -&gt;silence.pre, pCIDDTMF -&gt;silence.end ); <span class="comment">//pre_silence = 300ms, end_silence = 300ms</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span>( pCIDDTMF -&gt;mode.bAutoSlicAction )</div>
<div class="line">        <a class="code" href="group__TAPI__DSP__CID__DTMF.html#gac7f0c2f318e571a35bb896c0cf607a9c" title="Generate DTMF Caller ID.">rtk_GenDtmfCid</a>( chid, pCIDDTMF -&gt;<span class="keywordtype">id</span>.<span class="keywordtype">string</span> );</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <a name="a6"></a><a class="code" href="group__TAPI__PHONE__PCM.html#ga467808500f63f327159004020ec25482" title="To disable or enable PCM channel as Narrowband/Wideband.">rtk_EnablePcm</a>( chid, 1 ); <span class="comment">// enable PCM before generating dtmf caller id</span></div>
<div class="line">        <a name="a7"></a><a class="code" href="group__TAPI__PHONE__FXS.html#ga47d0828e9f49fc65b011fdae15fb9a4a" title="Set FXS On Hook Transmission and turn On PCM channel for data transfer   This API has two actions...">rtk_SetFxsOnHookTransPcmOn</a>( chid ); <span class="comment">// enable SLIC on-hook transmission to pass caller ID</span></div>
<div class="line">        <span class="comment">// set cid CID String </span></div>
<div class="line">        <a name="a8"></a><a class="code" href="group__TAPI__DSP__CID__DTMF.html#ga65673979b0cd279fd848c60508d0f9d5" title="Set Caller ID string for DTMF generation.">rtk_SetDtmfCidString</a>( chid, pCIDDTMF -&gt;<span class="keywordtype">id</span>.<span class="keywordtype">string</span> ); </div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// wait for DTMF complete, or off-hook event </span></div>
<div class="line">    printf( <span class="stringliteral">&quot;Wait for DTMF caller ID complete, or off-hook to break...&quot;</span> );</div>
<div class="line">    fflush( stdout );</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span>( 1 ) {</div>
<div class="line">        <span class="comment">// DTMF complete? </span></div>
<div class="line">        <a name="a9"></a><a class="code" href="group__TAPI__PHONE__EVENT.html#ga136a4269e357f7616419d456578f14c2" title="Retrieve DSP Event, such as tone end event, caller ID end event.">rtk_GetDspEvent</a>( chid, 0, &amp;dsp_event, NULL);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span>( dsp_event == <a name="a10"></a><a class="code" href="voip__params_8h.html#adc20e233fff4ea8af423ffe7a8a1029daccbed3d654213a0de4033114484070aa" title="DTMF CLID END Event.">VEID_DSP_DTMF_CLID_END</a> ) {</div>
<div class="line">            printf( <span class="stringliteral">&quot;complete!!\n&quot;</span> );</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// off-hook event to stop caller ID </span></div>
<div class="line">        <span class="keywordflow">if</span>( !pCIDDTMF -&gt;mode.bAutoSlicAction ) {</div>
<div class="line">            <a name="a11"></a><a class="code" href="group__TAPI__PHONE__EVENT.html#ga4fcb1f88e43f1c445d8482e64210bfa7" title="Get the SLIC state.">rtk_GetSlicEvent</a>( chid, &amp;slic_event );</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span>( slic_event == SLICEVENT_OFFHOOK ) {</div>
<div class="line">                <a name="a12"></a><a class="code" href="group__TAPI__DSP__CID.html#gabe2da6fb70e41a848b132e7defd4f392" title="Stop Caller ID Generation.">rtk_StopCid</a>( chid, 2 );</div>
<div class="line">                printf( <span class="stringliteral">&quot;off-hook!!\n&quot;</span> );</div>
<div class="line">                <span class="keywordflow">break</span>;  <span class="comment">// stop CID!! we can&#39;t recv complete event </span></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        usleep( 1 );    <span class="comment">// light busy loop </span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span>( !pCIDDTMF -&gt;mode.bAutoSlicAction ) {</div>
<div class="line">        <a class="code" href="group__TAPI__PHONE__PCM.html#ga467808500f63f327159004020ec25482" title="To disable or enable PCM channel as Narrowband/Wideband.">rtk_EnablePcm</a>( chid, 0 ); <span class="comment">// disable PCM after generating dtmf caller id    </span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// part 3: ring by AP (optional)</span></div>
<div class="line">    <span class="keywordflow">if</span>( !pCIDDTMF -&gt;mode.bAutoRing ) {</div>
<div class="line">        <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>( chid, 1 );</div>
<div class="line">        printf( <span class="stringliteral">&quot;Turn on SLIC ring by AP\n&quot;</span> );</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// stop log</span></div>
<div class="line">    printf( <span class="stringliteral">&quot;stop log\n&quot;</span> );</div>
<div class="line">    system( <span class="stringliteral">&quot;killall cat&quot;</span> );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// wait moment </span></div>
<div class="line">    printf( <span class="stringliteral">&quot;Wait 5 seconds, and then turn off ring...\n&quot;</span> );</div>
<div class="line">    sleep( 5 );</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>( chid, 0 );</div>
<div class="line">    printf( <span class="stringliteral">&quot;Turn off SLIC ring by AP.... complete test item\n------\n&quot;</span> );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> CID_DTMF_predefined_verification( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> test_set )</div>
<div class="line">{</div>
<div class="line">    CID_DTMF_verify_t CID_DTMF;</div>
<div class="line">    <span class="comment">//const char *pstr;</span></div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">#define M_AUTO_DIGIT( on, start, end )      CID_DTMF.mode.bAutoDigit = on;  \</span></div>
<div class="line"><span class="preprocessor">                                            CID_DTMF.mode.nStartDigit = start;  \</span></div>
<div class="line"><span class="preprocessor">                                            CID_DTMF.mode.nEndDigit = end;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define M_AUTO_RING( on, before )           CID_DTMF.mode.bAutoRing = on;   \</span></div>
<div class="line"><span class="preprocessor">                                            CID_DTMF.mode.bBeforeFirstRing = before;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define M_AUTO_SLIC_ACT( on )               CID_DTMF.mode.bAutoSlicAction = on;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define M_DURATION( on1, pause1 )           CID_DTMF.duration.on = on1; \</span></div>
<div class="line"><span class="preprocessor">                                            CID_DTMF.duration.pause = pause1;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define M_SILENCE( pre1, end1 )             CID_DTMF.silence.pre = pre1;    \</span></div>
<div class="line"><span class="preprocessor">                                            CID_DTMF.silence.end = end1;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define M_ID_STRING( str )                  strcpy( CID_DTMF.id.string, str );</span></div>
<div class="line"><span class="preprocessor"></span>    </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * DTMF caller ID verfication </span></div>
<div class="line"><span class="comment">     * --------------------------</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * format of DTMF caller ID: </span></div>
<div class="line"><span class="comment">     *   [ring] + silence pre + DTMF start + DTMF ID + DTMF end + silence end + ring </span></div>
<div class="line"><span class="comment">     *                          (      duration on / off       )</span></div>
<div class="line"><span class="comment">     * </span></div>
<div class="line"><span class="comment">     * </span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    </div>
<div class="line">    system( <span class="stringliteral">&quot;killall solar_monitor&quot;</span> );</div>
<div class="line">    system( <span class="stringliteral">&quot;killall solar&quot;</span> );</div>
<div class="line">    </div>
<div class="line">    printf( <span class="stringliteral">&quot;CID DTMF predefined verfication\n&quot;</span> );</div>
<div class="line">    printf( <span class="stringliteral">&quot;Test set are:\n&quot;</span> );</div>
<div class="line">    <span class="keywordflow">if</span>( test_set &amp; 0x01 )</div>
<div class="line">        printf( <span class="stringliteral">&quot;\t(A: Auto ring with long digits)\n&quot;</span> );</div>
<div class="line">    <span class="keywordflow">if</span>( test_set &amp; 0x02 )</div>
<div class="line">        printf( <span class="stringliteral">&quot;\t(B: AP ring with long digits)\n&quot;</span> );  </div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">#if 1   // Auto ring </span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span>( ( test_set &amp; 0x01 ) == 0 )</div>
<div class="line">        <span class="keywordflow">goto</span> label_auto_ring_test_set_done;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// A0. ring + &#39;A&#39; + &#39;886852963741&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 1, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 1 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;886852963741&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// A1. &#39;A&#39; + &#39;886852963741&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 1, 1 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 1 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;886852963741&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// A2. ring + &#39;A886852963741C&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 0, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 1, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 1 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;A886852963741C&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// A3. ring + &#39;886852963741&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 0, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 1, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 1 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;886852963741&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// A4. ring + &#39;A&#39; + &#39;886852963741&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    <span class="comment">// cmp with A0 - duration ( 150, 60 )</span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 1, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 1 );</div>
<div class="line">    M_DURATION( 150, 60 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;886852963741&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF ); </div>
<div class="line"></div>
<div class="line">    <span class="comment">// A5. ring + &#39;A&#39; + &#39;886852963741&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    <span class="comment">// cmp with A0 - silence ( 500, 200 )</span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 1, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 1 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 500, 200 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;886852963741&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF ); </div>
<div class="line">        </div>
<div class="line">label_auto_ring_test_set_done:</div>
<div class="line">    ;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if 1   // AP ring </span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span>( ( test_set &amp; 0x02 ) == 0 )</div>
<div class="line">        <span class="keywordflow">goto</span> label_AP_ring_test_set_done;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// B0. ring + &#39;A&#39; + &#39;0088635780211&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 0, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 0 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;0088635780211&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// B1. &#39;A&#39; + &#39;0088635780211&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 0, 1 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 0 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;0088635780211&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// B2. ring + &#39;A0088635780211C&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 0, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 0, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 0 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;A0088635780211C&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line"></div>
<div class="line">    <span class="comment">// B3. ring + &#39;0088635780211&#39; + ring </span></div>
<div class="line">    M_AUTO_DIGIT( 0, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 0, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 0 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;0088635780211&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line"></div>
<div class="line">    <span class="comment">// B4. ring + &#39;A&#39; + &#39;0088635780211&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    <span class="comment">// cmp with B0 - duration ( 150, 60 )</span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 0, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 0 );</div>
<div class="line">    M_DURATION( 150, 60 );</div>
<div class="line">    M_SILENCE( 300, 300 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;0088635780211&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// B5. ring + &#39;A&#39; + &#39;0088635780211&#39; + &#39;C&#39; + ring </span></div>
<div class="line">    <span class="comment">// cmp with B0 - silence ( 500, 200 )</span></div>
<div class="line">    M_AUTO_DIGIT( 1, DTMF_DIGIT_a, DTMF_DIGIT_c );</div>
<div class="line">    M_AUTO_RING( 0, 0 );</div>
<div class="line">    M_AUTO_SLIC_ACT( 0 );</div>
<div class="line">    M_DURATION( 80, 80 );</div>
<div class="line">    M_SILENCE( 500, 200 );</div>
<div class="line">    M_ID_STRING( <span class="stringliteral">&quot;0088635780211&quot;</span> );</div>
<div class="line">    Run_CID_DTMF_verification( &amp;CID_DTMF );</div>
<div class="line">    </div>
<div class="line">label_AP_ring_test_set_done:</div>
<div class="line">    ;</div>
<div class="line"><span class="preprocessor">#endif  </span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 3 2014 11:37:43 for VoIP Interface by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
