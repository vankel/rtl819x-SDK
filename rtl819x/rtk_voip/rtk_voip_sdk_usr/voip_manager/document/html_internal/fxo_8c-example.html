<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIP Interface: Main Page2</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head>
<img src=realtek.jpg>
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">fxo.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Example for FXO operation</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="voip__manager_8h.html" title="VoIP control API.">voip_manager.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// test option:</span></div>
<div class="line"><span class="comment">//  - FXO_DIAL_FXS0 has defined</span></div>
<div class="line"><span class="comment">//      * fxo ring will dial fxs0 automatically</span></div>
<div class="line"><span class="comment">//  - FXO_DIAL_FXS0 has not defined</span></div>
<div class="line"><span class="comment">//      * fxo ring will prompt user dial voip number via IVR</span></div>
<div class="line"><span class="preprocessor">#define FXO_DIAL_FXS0_AUTO</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define FUNCKEY_FXO_0   &quot;.0&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FUNCKEY_FXO_1   &quot;.1&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FUNCKEY_FXO_2   &quot;.2&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FUNCKEY_FXO_3   &quot;.3&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FUNCKEY_FXS_0   &quot;.4&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FUNCKEY_FXS_1   &quot;.5&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CHANNEL_IS_FXS(chid)    RTK_VOIP_IS_SLIC_CH( chid, g_VoIP_Feature )</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CHANNEL_IS_FXO(chid)    RTK_VOIP_IS_DAA_CH( chid, g_VoIP_Feature )</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">    FXO_NO_DAA = 0,</div>
<div class="line">    FXO_VIRTUAL_DAA,</div>
<div class="line">    FXO_DAA</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">    STATE_IDLE = 0,</div>
<div class="line">    STATE_RING,</div>
<div class="line">    STATE_CONNECT,</div>
<div class="line">    STATE_DAA_RING,         <span class="comment">// virtual daa state</span></div>
<div class="line">    STATE_DAA_CONNECT       <span class="comment">// virtual daa state</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">    DIAL_NONE = 0,</div>
<div class="line">    DIAL_FXO_0,</div>
<div class="line">    DIAL_FXO_1,</div>
<div class="line">    DIAL_FXO_2,</div>
<div class="line">    DIAL_FXO_3,</div>
<div class="line">    DIAL_FXS_0,</div>
<div class="line">    DIAL_FXS_1,</div>
<div class="line">    DIAL_OTHER,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>channel_s channel_t;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>channel_s {</div>
<div class="line">    <span class="comment">// phone info</span></div>
<div class="line">    <span class="keywordtype">int</span> chid;</div>
<div class="line">    <span class="keywordtype">int</span> state;</div>
<div class="line">    <span class="keywordtype">char</span> dial_code[101];</div>
<div class="line">    <span class="keywordtype">int</span> dial_index;</div>
<div class="line">    <span class="comment">// rtp info</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ip;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port;</div>
<div class="line">    <span class="comment">// remote channel (just peer simulation)</span></div>
<div class="line">    channel_t *remote;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_init(channel_t *channel, <span class="keywordtype">int</span> chid);</div>
<div class="line"><span class="keywordtype">void</span> channel_reset(channel_t *channel, <span class="keywordtype">int</span> chid);</div>
<div class="line"><span class="keywordtype">int</span> channel_input(channel_t *channel, <a class="code" href="voip__manager_8h.html#ac3d830d3c2e104857c0628ae98e456f8">SIGNSTATE</a> val);</div>
<div class="line"><span class="keywordtype">void</span> channel_dial_local(channel_t *channel, channel_t *remote_channel);</div>
<div class="line"><span class="keywordtype">void</span> channel_dial_out(channel_t *channel);</div>
<div class="line"><span class="keywordtype">void</span> channel_switch_to_fxo(channel_t *channel); <span class="comment">// virtual daa</span></div>
<div class="line"><span class="keywordtype">void</span> channel_rtp_start(channel_t *channel);</div>
<div class="line"><span class="keywordtype">void</span> channel_t38_start(channel_t *channel);</div>
<div class="line"><span class="keywordtype">void</span> channel_rtp_stop(channel_t *channel);</div>
<div class="line"></div>
<div class="line"><span class="comment">// global variable</span></div>
<div class="line"><span class="keywordtype">int</span> fxo_type;</div>
<div class="line">channel_t channels[CON_CH_NUM];</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_init(channel_t *channel, <span class="keywordtype">int</span> chid)</div>
<div class="line">{</div>
<div class="line">    memset(channel, 0, <span class="keyword">sizeof</span>(*channel));</div>
<div class="line">    <span class="comment">// phone</span></div>
<div class="line">    channel-&gt;chid = chid;</div>
<div class="line">    channel-&gt;state = STATE_IDLE;</div>
<div class="line">    channel-&gt;dial_code[0] = 0;</div>
<div class="line">    channel-&gt;dial_index = 0;</div>
<div class="line">    <span class="comment">// rtp</span></div>
<div class="line">    channel-&gt;ip = ntohl(inet_addr(<span class="stringliteral">&quot;127.0.0.1&quot;</span>));</div>
<div class="line">    channel-&gt;port = 9000 + chid;</div>
<div class="line">    <span class="comment">// reomte </span></div>
<div class="line">    channel-&gt;remote = NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> channel_input(channel_t *channel, <a class="code" href="voip__manager_8h.html#ac3d830d3c2e104857c0628ae98e456f8">SIGNSTATE</a> val)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (channel-&gt;dial_index &gt;= <span class="keyword">sizeof</span>(channel-&gt;dial_code) - 1) </div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;%s: out of buffer\n&quot;</span>, __FUNCTION__);</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_NONE;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (val &gt;= SIGN_KEY1 &amp;&amp; val &lt;= SIGN_KEY9) </div>
<div class="line">        channel-&gt;dial_code[channel-&gt;dial_index++] = (char) <span class="charliteral">&#39;0&#39;</span> + val;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val == SIGN_KEY0)</div>
<div class="line">        channel-&gt;dial_code[channel-&gt;dial_index++] = <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val == SIGN_STAR)</div>
<div class="line">        channel-&gt;dial_code[channel-&gt;dial_index++] = <span class="charliteral">&#39;.&#39;</span>;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val == SIGN_HASH)</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_OTHER;</div>
<div class="line"></div>
<div class="line">    channel-&gt;dial_code[channel-&gt;dial_index] = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// check local dial</span></div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(channel-&gt;dial_code, FUNCKEY_FXO_0) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_FXO_0;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(channel-&gt;dial_code, FUNCKEY_FXO_1) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_FXO_1;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(channel-&gt;dial_code, FUNCKEY_FXO_2) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_FXO_2;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(channel-&gt;dial_code, FUNCKEY_FXO_3) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_FXO_3;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(channel-&gt;dial_code, FUNCKEY_FXS_0) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_FXS_0;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(channel-&gt;dial_code, FUNCKEY_FXS_1) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> DIAL_FXS_1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> DIAL_NONE;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_dial_local(channel_t *channel, channel_t *remote_channel)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (remote_channel-&gt;chid == channel-&gt;chid)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;%s: couldn&#39;t dial itself\n&quot;</span>, __FUNCTION__);</div>
<div class="line">        <a name="a0"></a><a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a name="a1"></a><a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a name="a2"></a><a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 1. create local rtp</span></div>
<div class="line">    channel-&gt;remote = remote_channel;</div>
<div class="line">    channel_rtp_start(channel);</div>
<div class="line">    channel-&gt;state = STATE_CONNECT;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 2. signal remote channel</span></div>
<div class="line">    remote_channel-&gt;remote = channel;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (CHANNEL_IS_FXS(remote_channel-&gt;chid))</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a name="a3"></a><a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda7a9e5f38b257cea629fc98f17ccccfb9" title="ring back tone, code = 70 in RFC2833, index = 16">DSPCODEC_TONE_RINGING</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">        <span class="comment">// signal fxs</span></div>
<div class="line">        <a name="a4"></a><a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>(remote_channel-&gt;chid, 1);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {   </div>
<div class="line">        <span class="comment">// signal fxo</span></div>
<div class="line">        <a name="a5"></a><a class="code" href="group__TAPI__PHONE__FXO.html#ga2f2ae2a3c8a56f50dda2b097b8a000d6" title="Let FXO Ringing.">rtk_FxoRingOn</a>(remote_channel-&gt;chid);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    remote_channel-&gt;state = STATE_RING;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_resetup_local_rtp(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    channel_rtp_stop(channel);</div>
<div class="line">    channel_rtp_start(channel);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_resetup_local_t38(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    channel_rtp_stop(channel);</div>
<div class="line">    channel_t38_start(channel);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_dial_out(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s: dial %s done.\n&quot;</span>, __FUNCTION__, channel-&gt;dial_code);</div>
<div class="line">    <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_switch_to_fxo(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a6"></a><a class="code" href="group__TAPI__OBSOLETE__GROUP.html#ga8373bb6abff242a83722d0368f529b2e" title="Switch virtual DAA relay to PSTN line (replaced by rtk_FxoOffHook)">rtk_DaaOffHook</a>(channel-&gt;chid) == 0)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;%s: ok.\n&quot;</span>, __FUNCTION__);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span>    <span class="comment">// pstn out failed</span></div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;%s: failed.\n&quot;</span>, __FUNCTION__);</div>
<div class="line">        <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_rtp_start(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    <a name="_a7"></a><a class="code" href="structrtp__config__t.html" title="Structure for RTP handling  ">rtp_config_t</a> rtp_config;</div>
<div class="line">    <a name="_a8"></a><a class="code" href="structpayloadtype__config__t.html" title="Structure for RTP payload type  ">payloadtype_config_t</a> codec_config;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// set rtp session</span></div>
<div class="line">    rtp_config.<a name="a9"></a><a class="code" href="structrtp__config__t.html#a6835ba1d83a5bcc4bd0af7d83076ea6a" title="channel id">chid</a> = channel-&gt;chid;</div>
<div class="line">    rtp_config.<a name="a10"></a><a class="code" href="structrtp__config__t.html#ae30a7620430762b93c1792477cb0eaeb" title="session id. Usually 0 for master session, 1 for slave(conference) session.">sid</a> = 0;</div>
<div class="line">    rtp_config.<a name="a11"></a><a class="code" href="structrtp__config__t.html#a1630c48e70b3818c1b46fa3d2ee0a8ef" title="Not support yet. tcp = 1 or udp = 0.">isTcp</a> = 0;       <span class="comment">// use udp</span></div>
<div class="line">    rtp_config.<a name="a12"></a><a class="code" href="structrtp__config__t.html#ab99c37801711581655f5833a38f70044" title="local IP address for RTP">extIp</a> = htonl(channel-&gt;ip);</div>
<div class="line">    rtp_config.<a name="a13"></a><a class="code" href="structrtp__config__t.html#a959b92e3bb71c4d081f1dd7975906d9f" title="remote IP address for RTP">remIp</a> = htonl(channel-&gt;remote-&gt;ip);</div>
<div class="line">    rtp_config.<a name="a14"></a><a class="code" href="structrtp__config__t.html#ae95db080a339d14e8c5860a689d55e35" title="local RTP port number">extPort</a> = htons(channel-&gt;port);</div>
<div class="line">    rtp_config.<a name="a15"></a><a class="code" href="structrtp__config__t.html#a427f96d3294a74896580c54c2fa8a171" title="remote RTP port number">remPort</a> = htons(channel-&gt;remote-&gt;port);</div>
<div class="line"><span class="preprocessor">#ifdef SUPPORT_VOICE_QOS</span></div>
<div class="line"><span class="preprocessor"></span>    rtp_config.tos = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    rtp_config.<a name="a16"></a><a class="code" href="structrtp__config__t.html#a217fe384b06c22665689c5c558ed795d" title="local rfc2833 payload type  rfc2833_payload_type_locale MUST be set from application to DSP...">rfc2833_payload_type_local</a> = 0;      <span class="comment">// use in-band</span></div>
<div class="line">    rtp_config.<a name="a17"></a><a class="code" href="structrtp__config__t.html#aa50cbeaa509c7554e85fe2c125ed6cca" title="remote rfc2833 payload type  rfc2833_payload_type_remote MUST be set from application to DSP...">rfc2833_payload_type_remote</a> = 0;     <span class="comment">// use in-band</span></div>
<div class="line">    rtp_config.<a name="a18"></a><a class="code" href="structrtp__config__t.html#ad5526fa524c914af80c5ab112b850536" title="local Fax/Modem rfc2833 payload type">rfc2833_fax_modem_pt_local</a> = 0;      <span class="comment">// use in-band</span></div>
<div class="line">    rtp_config.<a name="a19"></a><a class="code" href="structrtp__config__t.html#a65be43b15030c9d62a09e47e5c670841" title="remote Fax/Modem rfc2833 payload type">rfc2833_fax_modem_pt_remote</a> = 0;     <span class="comment">// use in-band</span></div>
<div class="line"><span class="preprocessor">#if defined(SUPPORT_RTP_REDUNDANT_APP)</span></div>
<div class="line"><span class="preprocessor"></span>    rtp_config.<a name="a20"></a><a class="code" href="structrtp__config__t.html#abacf7214ccfa686dde4da5c47797fb7f" title="Payload type of local redundant rtp. 0 means disable rtp redundant.">rtp_redundant_payload_type_local</a> = 0;</div>
<div class="line">    rtp_config.<a name="a21"></a><a class="code" href="structrtp__config__t.html#a584d18c8335c56d12c61a324af24eab8" title="Payload type of remote redundant rtp 0 means disable rtp redundant.">rtp_redundant_payload_type_remote</a> = 0;</div>
<div class="line">    rtp_config.<a name="a22"></a><a class="code" href="structrtp__config__t.html#aefa61ecebb4c33ad03b235b7d8282e56" title="Maximum RTP redundancy number in TX direction (0~2). 0 means no RTP redundancy.">rtp_redundant_max_Audio</a> = 0;</div>
<div class="line">    rtp_config.<a name="a23"></a><a class="code" href="structrtp__config__t.html#a5649f8db4f869bb73fc3d9337ba7cb98" title="Maximum RFC 2833 redundancy number in TX direction (0~5). 0 means no RFC 2833 redundancy.">rtp_redundant_max_RFC2833</a> = 0;</div>
<div class="line"><span class="preprocessor">#elif defined(SUPPORT_RTP_REDUNDANT)</span></div>
<div class="line"><span class="preprocessor"></span>    rtp_config.<a class="code" href="structrtp__config__t.html#abacf7214ccfa686dde4da5c47797fb7f" title="Payload type of local redundant rtp. 0 means disable rtp redundant.">rtp_redundant_payload_type_local</a> = 0;</div>
<div class="line">    rtp_config.<a class="code" href="structrtp__config__t.html#a584d18c8335c56d12c61a324af24eab8" title="Payload type of remote redundant rtp 0 means disable rtp redundant.">rtp_redundant_payload_type_remote</a> = 0;</div>
<div class="line">    rtp_config.<a class="code" href="structrtp__config__t.html#aefa61ecebb4c33ad03b235b7d8282e56" title="Maximum RTP redundancy number in TX direction (0~2). 0 means no RTP redundancy.">rtp_redundant_max_Audio</a> = 0;</div>
<div class="line">    rtp_config.<a class="code" href="structrtp__config__t.html#a5649f8db4f869bb73fc3d9337ba7cb98" title="Maximum RFC 2833 redundancy number in TX direction (0~5). 0 means no RFC 2833 redundancy.">rtp_redundant_max_RFC2833</a> = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    rtp_config.<a name="a24"></a><a class="code" href="structrtp__config__t.html#ae539171a25479d0ef291c01aea8741c8" title="Payload type of local SID (Silence Insertion Description). 13 is recommend.">SID_payload_type_local</a> = 0;</div>
<div class="line">    rtp_config.<a name="a25"></a><a class="code" href="structrtp__config__t.html#a251fe201cd44524df63f076a8756ad71" title="Payload type of remote SID (Silence Insertion Description). 13 is recommend.">SID_payload_type_remote</a> = 0;</div>
<div class="line">    rtp_config.<a name="a26"></a><a class="code" href="structrtp__config__t.html#a864753145110bf95e0a4b86ad32a2dcc" title="initialize seqno, SSRC and timestamp randomly, so ignore below parameters">init_randomly</a> = 1;</div>
<div class="line">    rtp_config.<a name="a27"></a><a class="code" href="structrtp__config__t.html#ab2fdc41617ee0e672181577c00944219" title="initial seqno">init_seqno</a> = 0;</div>
<div class="line">    rtp_config.<a name="a28"></a><a class="code" href="structrtp__config__t.html#abf984d1afc9ee6616d163d1ecc04b28d" title="initial SSRC">init_SSRC</a> = 0;</div>
<div class="line">    rtp_config.<a name="a29"></a><a class="code" href="structrtp__config__t.html#a70cd97dacde76a2364592cc3db18a0be" title="initial timestamp">init_timestamp</a> = 0;</div>
<div class="line">    <a name="a30"></a><a class="code" href="group__TAPI__MEDIA__RTP.html#ga20fe6f6be15faef8c57328ab22f95393" title="Set RTP configuration.">rtk_SetRtpConfig</a>(&amp;rtp_config);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// set rtp payload, and other session parameters.</span></div>
<div class="line">    codec_config.<a name="a31"></a><a class="code" href="structpayloadtype__config__t.html#a7a81ef5b12c7b2c492e2f466402b3fba" title="channel id">chid</a> = channel-&gt;chid;</div>
<div class="line">    codec_config.<a name="a32"></a><a class="code" href="structpayloadtype__config__t.html#a717481154070dc5fe2399c656c661ace" title="session id. Usually 0 for master session, 1 for slave(conference) session.">sid</a> = 0;</div>
<div class="line">    codec_config.<a name="a33"></a><a class="code" href="structpayloadtype__config__t.html#af983fd7e21d7a15b3e01dd835a070261" title="Payload type of local voice codec.">local_pt</a> = 0;</div>
<div class="line">    codec_config.<a name="a34"></a><a class="code" href="structpayloadtype__config__t.html#a715fb4beb036ad7703243258c88e4c9a" title="Payload type of remote voice codec.">remote_pt</a> = 0;</div>
<div class="line">    codec_config.<a name="a35"></a><a class="code" href="structpayloadtype__config__t.html#a82eb57ddce9ba8e980f700f37418455c" title="Codec of desired local(Tx) voice codec.">uLocalPktFormat</a> = rtpPayloadPCMU;</div>
<div class="line">    codec_config.<a name="a36"></a><a class="code" href="structpayloadtype__config__t.html#a895a3d53bfe8b656f96125c3322e49db" title="Codec of desired remote(Rx) voice codec.">uRemotePktFormat</a> = rtpPayloadPCMU;</div>
<div class="line">    codec_config.<a name="a37"></a><a class="code" href="structpayloadtype__config__t.html#aac8c4492c426f10e4ee22ce5838c801b" title="Payload type of local voice band data (vbd).">local_pt_vbd</a> = rtpPayloadUndefined;</div>
<div class="line">    codec_config.<a name="a38"></a><a class="code" href="structpayloadtype__config__t.html#a45b5dd95db0de40fe811c2c890fc716d" title="Payload type in remote voice band data (vbd).">remote_pt_vbd</a> = rtpPayloadUndefined;</div>
<div class="line">    codec_config.<a name="a39"></a><a class="code" href="structpayloadtype__config__t.html#ada6bbf4c14e274e6adc90ac51a38494c" title="Codec type of voice band data (vbd). Usually used by V.152 FAX.">uPktFormat_vbd</a> = rtpPayloadUndefined;</div>
<div class="line">    codec_config.<a name="a40"></a><a class="code" href="structpayloadtype__config__t.html#a51db5ebb75d4929816d0aa4967d2bc49" title="G.723.1 rate. There are two bit rates at which G.723.1 can operate.  Valid values are:  0: 6...">nG723Type</a> = 0;</div>
<div class="line">    codec_config.<a name="a41"></a><a class="code" href="structpayloadtype__config__t.html#a921c890c8d1f7ae8b8cc0cabf27bf778" title="Frame per packet of local (Tx) voice codec.">nLocalFramePerPacket</a> = 1;</div>
<div class="line">    codec_config.<a name="a42"></a><a class="code" href="structpayloadtype__config__t.html#a5ec2b162f986c6016bf17dddd98c93d3" title="Frame per packet of remote (Rx) voice codec.">nRemoteFramePerPacket</a> = 1;</div>
<div class="line">    codec_config.<a name="a43"></a><a class="code" href="structpayloadtype__config__t.html#a0760774c59b4302c41a13c3f20ee971e" title="Frame per packet of voice codec (vbd)">nFramePerPacket_vbd</a> = 1;</div>
<div class="line">    codec_config.<a name="a44"></a><a class="code" href="structpayloadtype__config__t.html#aba143d7f2f2e9130cc729056b3668e66" title="Enable/Disable VAD (Voice activity detection)  Valid values are: 0: Disable 1: Enable.">bVAD</a> = 0;</div>
<div class="line">    codec_config.<a name="a45"></a><a class="code" href="structpayloadtype__config__t.html#ae31dc1e199838d927b4ff751e4dc4d5a" title="Enable/Disable PLC (Packet Loss Concealment)  Valid values are: 0: Disable 1: Enable.">bPLC</a> = 1;</div>
<div class="line">    codec_config.<a name="a46"></a><a class="code" href="structpayloadtype__config__t.html#a5edd303e38c49d0870ae64c0682b0bd1" title="minimun jitter delay (10ms)  nJitterDelay is the minimum delay of jitter buffer.  Valid values are 4 ...">nJitterDelay</a> = 4;</div>
<div class="line">    codec_config.<a name="a47"></a><a class="code" href="structpayloadtype__config__t.html#a1cf71efa5a26840869adc9ce70812506" title="maximum jitter delay (10ms)  nJitterDelay is the maximum delay of jitter buffer.  Valid values are 13...">nMaxDelay</a> = 13;</div>
<div class="line">    codec_config.<a name="a48"></a><a class="code" href="structpayloadtype__config__t.html#a2994da36a394d9edf2ff126817181e48" title="maximum strict jitter delay (10ms)  nMaxStrictDelay is the maximum strict delay of jitter buffer...">nMaxStrictDelay</a> = 10000;</div>
<div class="line">    codec_config.<a name="a49"></a><a class="code" href="structpayloadtype__config__t.html#a2435652e35b35df20454edaeca7942d0" title="optimzation factor of jitter buffer  The optimization factor is the value for adjusting the quality o...">nJitterFactor</a> = 7;</div>
<div class="line">    codec_config.<a name="a50"></a><a class="code" href="structpayloadtype__config__t.html#a671c4ba30e9bb37f85ea34c722c769d1" title="G726 packing order  Valid values are:  0: Packing none 1: Packing left 2: Packing right...">nG726Packing</a> = 2;<span class="comment">//pack right</span></div>
<div class="line">    <span class="keywordflow">if</span> ((codec_config.<a class="code" href="structpayloadtype__config__t.html#a82eb57ddce9ba8e980f700f37418455c" title="Codec of desired local(Tx) voice codec.">uLocalPktFormat</a> == rtpPayloadG722) ||</div>
<div class="line">        (codec_config.<a class="code" href="structpayloadtype__config__t.html#a895a3d53bfe8b656f96125c3322e49db" title="Codec of desired remote(Rx) voice codec.">uRemotePktFormat</a> == rtpPayloadG722) )</div>
<div class="line">        codec_config.<a name="a51"></a><a class="code" href="structpayloadtype__config__t.html#ad82d877ec1c901972f53d166a936c27f" title="PCM Mode Setting  Valid values are:  0: No action (use previous PCM enable mode)  1: Auto mode (DSP w...">nPcmMode</a> = 3;  <span class="comment">// wide-band</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        codec_config.<a class="code" href="structpayloadtype__config__t.html#ad82d877ec1c901972f53d166a936c27f" title="PCM Mode Setting  Valid values are:  0: No action (use previous PCM enable mode)  1: Auto mode (DSP w...">nPcmMode</a> = 2;  <span class="comment">// narrow-band</span></div>
<div class="line">    <a name="a52"></a><a class="code" href="group__TAPI__DSP__MEDIA.html#ga66c7ebfb55ed123876274a6f61ee6ded" title="Set RTP payload type.">rtk_SetRtpPayloadType</a>(&amp;codec_config);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// start rtp </span></div>
<div class="line">    <a name="a53"></a><a class="code" href="group__TAPI__MEDIA__RTP.html#ga2631053cf4aad5f78aa3d821ceed68d8" title="Set RTP Session State.">rtk_SetRtpSessionState</a>(channel-&gt;chid, 0, <a name="a54"></a><a class="code" href="voip__params_8h.html#a45391b9619a66d534df49c84149a4fcaa594fa9c4862d7d3d0dba9d0f4e231eea" title="RTP Session- Send/Recv.">rtp_session_sendrecv</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_t38_start(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    <a name="_a55"></a><a class="code" href="structt38udp__config__t.html" title="Structure for T.38 UDP connection.">t38udp_config_t</a> t38udp_config;</div>
<div class="line">    <a name="_a56"></a><a class="code" href="structt38__payloadtype__config__t.html" title="Structure for T.38 to be UDP payload type  ">t38_payloadtype_config_t</a> t38_config;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// set rtp session</span></div>
<div class="line">    t38udp_config.<a name="a57"></a><a class="code" href="structt38udp__config__t.html#aa82cee9403af63e2c2e81b6eecc171ae" title="channel id">chid</a> = channel-&gt;chid;</div>
<div class="line">    t38udp_config.<a name="a58"></a><a class="code" href="structt38udp__config__t.html#a7a360f7aaed7ef264f7f9d227200e0f5" title="session id. Usually 0 for master session, 1 for slave(conference) session.">sid</a> = 0;</div>
<div class="line">    t38udp_config.<a name="a59"></a><a class="code" href="structt38udp__config__t.html#a1a2cbf460d744a5a9b45859891096a7f" title="Not support yet. tcp = 1 or udp = 0.">isTcp</a> = 0;        <span class="comment">// use udp</span></div>
<div class="line">    t38udp_config.<a name="a60"></a><a class="code" href="structt38udp__config__t.html#a2f211566e362166b8204a6ded6de8208" title="local IP address for RTP">extIp</a> = htonl(channel-&gt;ip);</div>
<div class="line">    t38udp_config.<a name="a61"></a><a class="code" href="structt38udp__config__t.html#a21b3c66ee36436025736ecd61b4dab89" title="remote IP address for RTP">remIp</a> = htonl(channel-&gt;remote-&gt;ip);</div>
<div class="line">    t38udp_config.<a name="a62"></a><a class="code" href="structt38udp__config__t.html#a50a11e029ad8ebb6a5595cdcd71d9644" title="local RTP port number">extPort</a> = htons(channel-&gt;port);</div>
<div class="line">    t38udp_config.<a name="a63"></a><a class="code" href="structt38udp__config__t.html#a233c451500fd10a8d7a17d46a6066406" title="remote RTP port number">remPort</a> = htons(channel-&gt;remote-&gt;port);</div>
<div class="line"><span class="preprocessor">#ifdef SUPPORT_VOICE_QOS</span></div>
<div class="line"><span class="preprocessor"></span>    t38udp_config.tos = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    </div>
<div class="line">    <a name="a64"></a><a class="code" href="group__TAPI__MEDIA__T38.html#ga8d94f9e36737a4d995b763f6d8df4cf3" title="Set T.38 UDP configuration.">rtk_SetT38UdpConfig</a>(&amp;t38udp_config);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// set rtp payload, and other session parameters.</span></div>
<div class="line">    t38_config.<a name="a65"></a><a class="code" href="structt38__payloadtype__config__t.html#a7c4648dcae8daee27fdeb53e916b35ed" title="channel id">chid</a> = channel-&gt;chid;</div>
<div class="line">    t38_config.<a name="a66"></a><a class="code" href="structt38__payloadtype__config__t.html#a257e42bf81be731b83df2da148b04b5a" title="session id. Usually 0 for master session, 1 for slave(conference) session.">sid</a> = 0;</div>
<div class="line">    t38_config.<a name="a67"></a><a class="code" href="structt38__payloadtype__config__t.html#a04445f3b356d8d885a76442196cca613" title="Enable T.38 parameter. If false, default settings are adopted and nT38MaxBuffer and nT38RateMgt are i...">bT38ParamEnable</a> = 0;</div>
<div class="line">    t38_config.<a name="a68"></a><a class="code" href="structt38__payloadtype__config__t.html#a9d767c2530d1ce6c782734f6d98f435a" title="T.38 Max buffer size  Valid valures are 200 to 600 (ms)   Default is 500 (ms)">nT38MaxBuffer</a> = 0;</div>
<div class="line">    t38_config.<a name="a69"></a><a class="code" href="structt38__payloadtype__config__t.html#aa11be4804d626b22606bec0c3ac5fb78" title="T38 Rate management  Valid values are:  1: don&#39;t pass tcf data 2: pass tcf data (Default)">nT38RateMgt</a> = 0;</div>
<div class="line">    t38_config.<a name="a70"></a><a class="code" href="structt38__payloadtype__config__t.html#a9d066a3a75b1b1470aa09f0d27c1f635" title="T38 Maximum rate  Valid values are:  0: 2400 bps 1: 4800 bps 2: 7200 bps 3: 9600 bps 4: 12000 bps 5: ...">nT38MaxRate</a> = 0;</div>
<div class="line">    t38_config.<a name="a71"></a><a class="code" href="structt38__payloadtype__config__t.html#a94c4fb79caf315e9e16af9cee13567d2" title="T38 ECM  Valid values are:  0: disable 1: enable (Default)">bT38EnableECM</a> = 0;</div>
<div class="line">    t38_config.<a name="a72"></a><a class="code" href="structt38__payloadtype__config__t.html#a6a59baf589f2884f9d7d882aeaf68844" title="T38 ECC signal  Valid values are: 0~7  Default value: 5.">nT38ECCSignal</a> = 0;</div>
<div class="line">    t38_config.<a name="a73"></a><a class="code" href="structt38__payloadtype__config__t.html#a8677b5905bde696cc382bec50fdeb94a" title="T38 ECC data  Valid values are: 0~2  Default value: 2.">nT38ECCData</a> = 0;</div>
<div class="line">    t38_config.<a name="a74"></a><a class="code" href="structt38__payloadtype__config__t.html#a7dbb13aa8021ea640f078eba1d46009b" title="T38 Spoofing  Valid values are:  0: disable 1: enable (Default)">bT38EnableSpoof</a> = 0;</div>
<div class="line">    t38_config.<a name="a75"></a><a class="code" href="structt38__payloadtype__config__t.html#ae50a4bbb7591c671d2e5c55f016f04b0" title="T38 Packet Duplicate Num  Valid values are: 0~2  Default value: 0.">nT38DuplicateNum</a> = 0;</div>
<div class="line">    t38_config.<a name="a76"></a><a class="code" href="structt38__payloadtype__config__t.html#a73d738d7da0c9d7a9f45b5caac73c5a9" title="PCM Mode Setting  Valid values are:  0: No action (use previous PCM enable mode)  1: Auto mode (DSP w...">nPcmMode</a> = 2;    <span class="comment">// narrow-band</span></div>
<div class="line">    <a name="a77"></a><a class="code" href="group__TAPI__DSP__MEDIA.html#ga51842a9880e9a12ea177596c68f680ba" title="Set T.38 to be UDP payload type.">rtk_SetT38PayloadType</a>(&amp;t38_config);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// start rtp </span></div>
<div class="line">    <span class="comment">//rtk_SetRtpSessionState(channel-&gt;chid, 0, rtp_session_sendrecv);</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_rtp_stop(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__TAPI__MEDIA__RTP.html#ga2631053cf4aad5f78aa3d821ceed68d8" title="Set RTP Session State.">rtk_SetRtpSessionState</a>(channel-&gt;chid, 0, <a name="a78"></a><a class="code" href="voip__params_8h.html#a45391b9619a66d534df49c84149a4fcaa0f1821892441a90141e10d5e947e912e" title="RTP Session- Inactive.">rtp_session_inactive</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_handle_input(channel_t *channel, <a class="code" href="voip__manager_8h.html#ac3d830d3c2e104857c0628ae98e456f8">SIGNSTATE</a> val)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a name="a79"></a><a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda34743a7930889088b12bc64517dc48ff" title="code = 76 in RFC2833, index = 37">DSPCODEC_TONE_HOLD</a>, 0, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">    ret = channel_input(channel, val);</div>
<div class="line">    <span class="keywordflow">switch</span> (ret)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> DIAL_FXO_0:</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_NO_DAA)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;%s: no fxo\n&quot;</span>, __FUNCTION__);</div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_VIRTUAL_DAA)</div>
<div class="line">        {</div>
<div class="line">            channel_switch_to_fxo(channel);                         <span class="comment">// switch to fxo</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            channel_dial_local(channel, &amp;channels[RTK_VOIP_DAA_CH_OFFSET( <a name="a80"></a>g_VoIP_Feature )+0]); <span class="comment">// dial fxo 0</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DIAL_FXO_1:</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_NO_DAA)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;%s: no fxo\n&quot;</span>, __FUNCTION__);</div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_VIRTUAL_DAA)</div>
<div class="line">        {</div>
<div class="line">            channel_switch_to_fxo(channel);                         <span class="comment">// switch to fxo</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            channel_dial_local(channel, &amp;channels[RTK_VOIP_DAA_CH_OFFSET( g_VoIP_Feature )+1]); <span class="comment">// dial fxo 1</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DIAL_FXO_2:</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_NO_DAA)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;%s: no fxo\n&quot;</span>, __FUNCTION__);</div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_VIRTUAL_DAA)</div>
<div class="line">        {</div>
<div class="line">            channel_switch_to_fxo(channel);                         <span class="comment">// switch to fxo</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            channel_dial_local(channel, &amp;channels[RTK_VOIP_DAA_CH_OFFSET( g_VoIP_Feature )+2]); <span class="comment">// dial fxo 2</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DIAL_FXO_3:</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_NO_DAA)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;%s: no fxo\n&quot;</span>, __FUNCTION__);</div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (fxo_type == FXO_VIRTUAL_DAA)</div>
<div class="line">        {</div>
<div class="line">            channel_switch_to_fxo(channel);                         <span class="comment">// switch to fxo</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            channel_dial_local(channel, &amp;channels[RTK_VOIP_DAA_CH_OFFSET( g_VoIP_Feature )+3]); <span class="comment">// dial fxo 3</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DIAL_FXS_0:</div>
<div class="line">        channel_dial_local(channel, &amp;channels[0]);  <span class="comment">// dial fxs 0</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DIAL_FXS_1:</div>
<div class="line">        <span class="keywordflow">if</span> (RTK_VOIP_SLIC_NUM( g_VoIP_Feature ) &lt; 2)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;%s: no fxs 1\n&quot;</span>, __FUNCTION__);</div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        channel_dial_local(channel, &amp;channels[1]);  <span class="comment">// dial fxs 1</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> DIAL_OTHER:</div>
<div class="line">        channel_dial_out(channel);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="comment">// nothing</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_handle_onhook(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (channel-&gt;state)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> STATE_CONNECT:</div>
<div class="line">        channel_rtp_stop(channel);</div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(channel-&gt;chid))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// fxs</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// daa</span></div>
<div class="line">            <a name="a81"></a><a class="code" href="group__TAPI__PHONE__FXO.html#ga76f108dba36634e43d7b7ca2e9c87617" title="Let FXO on-hook.">rtk_FxoOnHook</a>(channel-&gt;chid);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// check remote channel is terminated </span></div>
<div class="line">        <span class="keywordflow">if</span> (channel-&gt;remote-&gt;remote == NULL) </div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// signal remote channel</span></div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(channel-&gt;remote-&gt;chid))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(channel-&gt;remote-&gt;state == STATE_RING)</div>
<div class="line">            {</div>
<div class="line">                channel-&gt;remote-&gt;state = STATE_IDLE;</div>
<div class="line">                <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>(channel-&gt;remote-&gt;chid, 0);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(channel-&gt;remote-&gt;state == STATE_CONNECT)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;remote-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda04e7a0c45a2c093d03effac94b749516" title="code = 72 in RFC2833, index = 17">DSPCODEC_TONE_BUSY</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">                channel_rtp_stop(channel-&gt;remote);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a name="a82"></a><a class="code" href="group__TAPI__PHONE__FXO.html#ga1a6420fcb2d839e4ea24960d1838c1f9" title="FXO Busy.">rtk_FxoBusy</a>(channel-&gt;remote-&gt;chid);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> STATE_DAA_CONNECT:</div>
<div class="line">        <span class="comment">// virtual daa</span></div>
<div class="line">        <a name="a83"></a><a class="code" href="group__TAPI__OBSOLETE__GROUP.html#ga0cc210de23e0f0b166bf559e674e88a9" title="On-Hook in PSTN line. (replaced by rtk_FxoOnHook)">rtk_DaaOnHook</a>(channel-&gt;chid);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef CONFIG_RTK_VOIP_IVR</span></div>
<div class="line"><span class="preprocessor"></span>    <a name="a84"></a><a class="code" href="group__TAPI__DSP__IVR.html#gafa9365fb5b1321480dcb7182aff64801" title="Stop playing immediately.">rtk_IvrStopPlaying</a>(channel-&gt;chid, 0); <span class="comment">// clear ivr</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <a name="a85"></a><a class="code" href="group__TAPI__MEDIA__MISC.html#gaed19a0479f028247263e839f224c7f56" title="Assign the active session.">rtk_SetTranSessionID</a>(channel-&gt;chid, 255);   <span class="comment">// clear resource count</span></div>
<div class="line">    <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda34743a7930889088b12bc64517dc48ff" title="code = 76 in RFC2833, index = 37">DSPCODEC_TONE_HOLD</a>, 0, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>); <span class="comment">// clear tone</span></div>
<div class="line">    channel_init(channel, channel-&gt;chid);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> channel_handle_offhook(channel_t *channel)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// active session 0, and record resource + 1</span></div>
<div class="line">    <a class="code" href="group__TAPI__MEDIA__MISC.html#gaed19a0479f028247263e839f224c7f56" title="Assign the active session.">rtk_SetTranSessionID</a>(channel-&gt;chid, 0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span> (channel-&gt;state)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> STATE_IDLE:</div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(channel-&gt;chid))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// fxs</span></div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a name="a86"></a><a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda5e89cb5eae76c4ce84c6f8f09cf0e1ed" title="code = 66 in RFC2833, index = 12">DSPCODEC_TONE_DIAL</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">char</span> caller_id[21];</div>
<div class="line">            <span class="keywordtype">char</span> caller_date[9];</div>
<div class="line">            <span class="keywordtype">char</span> caller_name[51];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #ifdef FXO_DIAL_FXS0_AUTO</span></div>
<div class="line"><span class="preprocessor"></span>            <a name="a87"></a><a class="code" href="group__TAPI__PHONE__FXO.html#gac9cc5de7469f4131e495f441fd7ff94e" title="Get the FXO Detected Caller ID.">rtk_GetDaaCallerID</a>(channel-&gt;chid, caller_id, caller_date, caller_name);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (caller_id[0])</div>
<div class="line">                printf(<span class="stringliteral">&quot;caller id is %s\n&quot;</span>, caller_id);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                printf(<span class="stringliteral">&quot;no caller id detect\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (caller_name[0])</div>
<div class="line">                printf(<span class="stringliteral">&quot;caller name is %s\n&quot;</span>, caller_name);</div>
<div class="line">                </div>
<div class="line"><span class="preprocessor">#if 1   // Gen FSK CID</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            <span class="comment">//rtk_SetCidFskGenMode(channel-&gt;chid - 4, 1); // soft gen</span></div>
<div class="line">            <a name="a88"></a><a class="code" href="group__TAPI__DSP__CID__FSK.html#ga268000217281f9636bc5179561d8c1aa" title="Set the FSK Area.">rtk_SetFskArea</a>(channel-&gt;chid - 4, 0x108<span class="comment">/*area*/</span>);   <span class="comment">/* area -&gt; 0:Bellcore 1:ETSI 2:BT 3:NTT */</span></div>
<div class="line">            <a name="a89"></a><a class="code" href="group__TAPI__DSP__CID.html#gac3319ca02ce9b01bde5be337766080bd" title="Caller ID generation and FXS Ring.">rtk_GenCidAndFxsRing</a>(channel-&gt;chid - 4, 1<span class="comment">/*fsk*/</span>, caller_id, caller_date, caller_name, 0<span class="comment">/*type1*/</span>, 0);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">//          channel_dial_local(channel, &amp;channels[0]);  // dial fxs 0</span></div>
<div class="line">            channel_dial_local(channel, &amp;channels[channel-&gt;chid - 4]);  <span class="comment">// dial fxs 0</span></div>
<div class="line"><span class="preprocessor">        #else</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordtype">char</span> text[] = {IVR_TEXT_ID_PLZ_ENTER_NUMBER, <span class="charliteral">&#39;\0&#39;</span>};</div>
<div class="line"></div>
<div class="line">            usleep(500000); <span class="comment">// after phone off-hook, wait for a second, and then play IVR</span></div>
<div class="line">            <a name="a90"></a><a class="code" href="group__TAPI__PHONE__FXO.html#gafe97a023b7da8016c08c3c79588a766e" title="Let DAA off-hook.">rtk_FxoOffHook</a>(channel-&gt;chid);</div>
<div class="line"><span class="preprocessor">        #ifdef CONFIG_RTK_VOIP_IVR</span></div>
<div class="line"><span class="preprocessor"></span>            <a name="a91"></a><a class="code" href="group__TAPI__DSP__IVR.html#ga2ad3fcb2f5f203961911d459147f5077" title="Play a text speech.">rtk_IvrStartPlaying</a>(channel-&gt;chid, 0, text);</div>
<div class="line"><span class="preprocessor">        #else</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="comment">// use dial tone to replace if no IVR</span></div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda5e89cb5eae76c4ce84c6f8f09cf0e1ed" title="code = 66 in RFC2833, index = 12">DSPCODEC_TONE_DIAL</a>, 1, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line"><span class="preprocessor">        #endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">        #endif</span></div>
<div class="line"><span class="preprocessor"></span>        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> STATE_RING:</div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(channel-&gt;chid))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// fxs</span></div>
<div class="line">            <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>(channel-&gt;chid, 0);</div>
<div class="line">            <a class="code" href="group__TAPI__DSP__TONE.html#gabdf79ea0528aebf4451782bafb5a0f01" title="Play/Stop the assigned tone.">rtk_SetPlayTone</a>(channel-&gt;remote-&gt;chid, 0, <a class="code" href="voip__params_8h.html#a110631afe96ae06621f3894e1014f1dda7a9e5f38b257cea629fc98f17ccccfb9" title="ring back tone, code = 70 in RFC2833, index = 16">DSPCODEC_TONE_RINGING</a>, 0, <a class="code" href="voip__params_8h.html#ab8ba0e766b9b42fab7e432d9370a6859a603db07fd09627f84ca635385b914182" title="local">DSPCODEC_TONEDIRECTION_LOCAL</a>);</div>
<div class="line">            channel_rtp_start(channel);</div>
<div class="line">            channel-&gt;state = STATE_CONNECT;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// daa</span></div>
<div class="line">            <a class="code" href="group__TAPI__PHONE__FXO.html#gafe97a023b7da8016c08c3c79588a766e" title="Let DAA off-hook.">rtk_FxoOffHook</a>(channel-&gt;chid);</div>
<div class="line">            channel_rtp_start(channel);</div>
<div class="line">            channel-&gt;state = STATE_CONNECT;</div>
<div class="line">        }</div>
<div class="line">                </div>
<div class="line">        <span class="comment">// ack remote channel</span></div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(channel-&gt;remote-&gt;chid))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// fxs</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// daa</span></div>
<div class="line">            <a class="code" href="group__TAPI__PHONE__FXO.html#gafe97a023b7da8016c08c3c79588a766e" title="Let DAA off-hook.">rtk_FxoOffHook</a>(channel-&gt;remote-&gt;chid);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> STATE_DAA_RING:</div>
<div class="line">        <span class="comment">// virtual daa</span></div>
<div class="line">        <a class="code" href="group__TAPI__OBSOLETE__GROUP.html#ga8373bb6abff242a83722d0368f529b2e" title="Switch virtual DAA relay to PSTN line (replaced by rtk_FxoOffHook)">rtk_DaaOffHook</a>(channel-&gt;chid);</div>
<div class="line">        channel-&gt;state = STATE_DAA_CONNECT;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    uint32 fax[CON_CH_NUM] = {0};</div>
<div class="line">    <span class="keywordtype">int</span> fax_clear[CON_CH_NUM] = {[0 ... CON_CH_NUM-1] = 1};</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>    uint32 fax_end[CON_CH_NUM] = {0};</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">int</span> fax_end_clear[CON_CH_NUM] = {[0 ... CON_CH_NUM-1] = 1};</div>
<div class="line"></div>
<div class="line">    <a class="code" href="voip__manager_8h.html#ac3d830d3c2e104857c0628ae98e456f8">SIGNSTATE</a> val;</div>
<div class="line">    channel_t *channel;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((g_VoIP_Feature &amp; DAA_TYPE_MASK) == NO_DAA)</div>
<div class="line">        fxo_type = FXO_NO_DAA;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((g_VoIP_Feature &amp; DAA_TYPE_MASK) == VIRTUAL_DAA)</div>
<div class="line">        fxo_type = FXO_VIRTUAL_DAA;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        fxo_type = FXO_DAA;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// init </span></div>
<div class="line">    <span class="keywordflow">for</span> (i=0; i&lt;CON_CH_NUM; i++)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// init dsp</span></div>
<div class="line">        <a name="a92"></a><a class="code" href="group__TAPI__DSP__INIT.html#ga4b32be720cdd238fb82cf0bad3db2114" title="Interface Initialization.">rtk_InitDsp</a>(i);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// init phone</span></div>
<div class="line">        <a name="a93"></a><a class="code" href="group__TAPI__DSP__AGC.html#gad577eab02d68e9ffaa9c9d32bf2cbda0" title="Set the speaker and mic voice gain.">rtk_SetVoiceGain</a>(i, 0, 0);  <span class="comment">// 0db</span></div>
<div class="line">        <a name="a94"></a><a class="code" href="group__TAPI__DSP__EC.html#ga3a53f50d7e0ab0595590ea1489dfaa94" title="Set echo tail for LEC.">rtk_SetEchoTail</a>(i, 1, 32, 1, 5, 5, 0);          <span class="comment">// EC-128, 32ms, NLP on</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// init fxs &amp; fxo</span></div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(i))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// fxs</span></div>
<div class="line">            <a name="a95"></a><a class="code" href="group__TAPI__PHONE__FXS.html#ga7f354b2656a3dfe992a1c10d0d769a5e" title="Setup the flash hook time.">rtk_SetFlashHookTime</a>(i, 100, 300);      <span class="comment">// 100~300 ms</span></div>
<div class="line">            <a name="a96"></a><a class="code" href="group__TAPI__PHONE__FXS.html#gab5119c109b8c69d55891904def9ba916" title="Set the ring cadence to a FXS line.">rtk_SetSlicRingCadence</a>(i, 1500, 1500);  <span class="comment">// 1500 ms</span></div>
<div class="line">            <a name="a97"></a><a class="code" href="group__TAPI__DSP__CID__DTMF.html#ga852dec0700b0a22055ccc6d816b690b0" title="Set the parameters of DTMF Caller ID Generation.">rtk_SetDtmfCidParam</a>(i, DTMF_DIGIT_A, DTMF_DIGIT_C, 0xf, 80, 80, 300, 300);  <span class="comment">// priori 1st ring, auto AC, auto ring, digit duration = 80ms, inter digit pause = 80ms</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// fxo</span></div>
<div class="line">            <a name="a98"></a><a class="code" href="group__TAPI__PHONE__FXO.html#gaaf5c5c25a5e88f11f8329065f462254b" title="Set the Ring Detection Parameters to FXO.">rtk_SetFxoRingDetection</a>(300, 300, 4500);</div>
<div class="line">            <a name="a99"></a><a class="code" href="group__TAPI__DSP__CID.html#ga3f1d659e190e24560ae0bb5aaacee2d4" title="Set the FXO Caller ID Detection Mode.">rtk_SetCidDetMode</a>(i,</div>
<div class="line">                2,                                      <span class="comment">// auto detect mode (NOT NTT)</span></div>
<div class="line">                CID_DTMF</div>
<div class="line">            );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// set dtmf mode</span></div>
<div class="line">        <a name="a100"></a><a class="code" href="group__TAPI__DSP__CID__DTMF.html#gab8245d14b7a7a684e1aa25e1188c137b" title="Set the DTMF mode.">rtk_SetDtmfMode</a>(i, DTMF_INBAND);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// set fax modem det mode</span></div>
<div class="line">        <a name="a101"></a><a class="code" href="group__TAPI__DSP__FAX.html#gafa2ffc3eff7c3da78d2262d44ca7f98f" title="Fax/Modem detect configuration.">rtk_SetFaxModemDet</a>(i, 0); <span class="comment">//0:auto-hi-speed-fax</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">// flush kernel fifo before app run</span></div>
<div class="line">        <a name="a102"></a><a class="code" href="group__TAPI__PHONE__EVENT.html#ga360048e105becaf697d40d0319655470" title="Flush the VoIP kernel used FIFO.">rtk_SetFlushFifo</a>(i);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// init local data</span></div>
<div class="line">        channel_init(&amp;channels[i], i);</div>
<div class="line"></div>
<div class="line">        <a name="a103"></a><a class="code" href="group__TAPI__DSP__INIT.html#ga1979f83338a3e2339d189f8dac51a193" title="Reinit DSP for FXS/FXO channel when on hook.">rtk_OnHookReinit</a>(i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// main loop</span></div>
<div class="line">main_loop:</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i=0; i&lt;CON_CH_NUM; i++)</div>
<div class="line">    {</div>
<div class="line">        channel = &amp;channels[i];</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(i))</div>
<div class="line">            <a name="a104"></a><a class="code" href="group__TAPI__OBSOLETE__GROUP.html#ga09c56bc79918bd82b057736c05905fde" title="Get the FXS state.">rtk_GetFxsEvent</a>(i, &amp;val);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <a name="a105"></a><a class="code" href="group__TAPI__OBSOLETE__GROUP.html#gae4ebf09cb3291af115c903b8095a32ec" title="Get the FXO state.">rtk_GetFxoEvent</a>(i, &amp;val);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Thlin add: once detect CED, change codec to T.38</span></div>
<div class="line">        <span class="comment">/*************** FAX Det ****************/</span></div>
<div class="line">        <span class="keywordflow">if</span> (CHANNEL_IS_FXS(i))</div>
<div class="line">        {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="comment">// Check FAX/Modem translated event</span></div>
<div class="line">            <a name="a106"></a><a class="code" href="group__TAPI__DSP__FAX.html#gad59b7f6e9f170ded5bc3a287be94dcc2" title="Fax/Modem detection, report CED tone , ANSam tone, V.21 DIS event.">rtk_GetFaxModemEvent</a>(i, &amp;fax[i], NULL, 0);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (((fax[i] == 1) || (fax[i] == 2))    <span class="comment">//1:low-speed fax, 2: high-speed fax, 3:local-modem, 4: remote-modem</span></div>
<div class="line">                &amp;&amp; (fax_clear[i] ==1))</div>
<div class="line">            {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Get FAX event %d, ch=%d\n&quot;</span>, fax[i], i);</div>
<div class="line">                channel_resetup_local_t38(channel);</div>
<div class="line">                channel_resetup_local_t38(channel-&gt;remote);</div>
<div class="line">                fax_clear[i] = 0;</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Check DCN, and restore to voice</span></div>
<div class="line">            <a name="a107"></a><a class="code" href="group__TAPI__DSP__FAX.html#gab71880b90885a076f5aca90ecafa9f66" title="Get Fax end detection result.">rtk_GetFaxEndDetect</a>(i, &amp;fax_end[i]); </div>
<div class="line">            <span class="keywordflow">if</span> ((fax_end[i] == 1) &amp;&amp; (fax_end_clear[i] == 1))</div>
<div class="line">            {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Get FAX End event, ch=%d\n&quot;</span>, i);</div>
<div class="line">                fax_end_clear[i] = 0;</div>
<div class="line">                </div>
<div class="line">                channel_resetup_local_rtp(channel);</div>
<div class="line">                channel_resetup_local_rtp(channel-&gt;remote);</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="comment">// Check FAX/Modem real event</span></div>
<div class="line">            <a class="code" href="group__TAPI__DSP__FAX.html#gad59b7f6e9f170ded5bc3a287be94dcc2" title="Fax/Modem detection, report CED tone , ANSam tone, V.21 DIS event.">rtk_GetFaxModemEvent</a>(i, NULL, &amp;fax[i], 0);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (((fax[i] == <a name="a108"></a><a class="code" href="voip__params_8h.html#adc20e233fff4ea8af423ffe7a8a1029dac2a159c256a3ae58e22f7347ab854227" title="FAX CED 2100HZ event.">VEID_FAXMDM_FAX_CED</a>) || </div>
<div class="line">                (fax[i] == <a name="a109"></a><a class="code" href="voip__params_8h.html#adc20e233fff4ea8af423ffe7a8a1029daa127fb72455a5cfdc94ffae725895ec3" title="FAX DIS event in receive path(TDM/PCM/Local)">VEID_FAXMDM_FAX_DIS_RX</a>) ||</div>
<div class="line">                (fax[i] == <a name="a110"></a><a class="code" href="voip__params_8h.html#adc20e233fff4ea8af423ffe7a8a1029da91ccd1fd4701b280efc002083312057e" title="FAX V21FLAG (DIS preamble) in receive path(TDM/PCM/Local)">VEID_FAXMDM_V21FLAG_LOCAL</a>) ||</div>
<div class="line">                (fax[i] == <a name="a111"></a><a class="code" href="voip__params_8h.html#adc20e233fff4ea8af423ffe7a8a1029daf1e29193187885e30c99d00a7db1202d" title="FAX CED/ANS tone in receive path(TDM/PCM/Local)">VEID_FAXMDM_ANSTONE_ANS_LOCAL</a>))</div>
<div class="line">                &amp;&amp; (fax_clear[i] ==1))</div>
<div class="line">            {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Get FAX event 0x%x, ch=%d\n&quot;</span>, fax[i], i);</div>
<div class="line">                channel_resetup_local_t38(channel);</div>
<div class="line">                channel_resetup_local_t38(channel-&gt;remote);</div>
<div class="line">                fax_clear[i] = 0;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> ( fax[i] != 0 )</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Get FAX/Modem event 0x%x, ch=%d\n&quot;</span>, fax[i], i);</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Check DCN, and restore to voice</span></div>
<div class="line">            <span class="keywordflow">if</span> ((fax[i] == <a name="a112"></a><a class="code" href="voip__params_8h.html#adc20e233fff4ea8af423ffe7a8a1029da869bbd2e926d8dd0907cfee312315be8" title="FAX DCN event in receive path(TDM/PCM/Local)">VEID_FAXMDM_FAX_DCN_RX</a>) &amp;&amp; (fax_end_clear[i] == 1))</div>
<div class="line">            {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Get FAX End event, ch=%d\n&quot;</span>, i);</div>
<div class="line">                fax_end_clear[i] = 0;</div>
<div class="line">                </div>
<div class="line">                channel_resetup_local_rtp(channel);</div>
<div class="line">                channel_resetup_local_rtp(channel-&gt;remote);</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        }</div>
<div class="line">        </div>
<div class="line">        uint32 dis = 0;</div>
<div class="line">        <a name="a113"></a><a class="code" href="group__TAPI__DSP__FAX.html#gaae942b1401aec07b13404fc38fe78c31" title="Get Fax DIS detection result in all path.">rtk_GetFaxDisDetect</a>(i, &amp;dis); </div>
<div class="line">        <span class="keywordflow">if</span> (dis == 1)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Get FAX DIS event, ch=%d\n&quot;</span>, i);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        dis = 0;</div>
<div class="line">        <a name="a114"></a><a class="code" href="group__TAPI__DSP__FAX.html#ga32ed85f2f3445325fc3c84267d0ae935" title="Get Fax Dis TX event detection result.">rtk_GetFaxDisTxDetect</a>(i, &amp;dis); </div>
<div class="line">        <span class="keywordflow">if</span> (dis == 1)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Get FAX DIS TX event, ch=%d\n&quot;</span>, i);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        dis = 0;</div>
<div class="line">        <a name="a115"></a><a class="code" href="group__TAPI__DSP__FAX.html#gabf24dc661bc21c938454e90734e113bf" title="Get Fax Dis RX event detection result.">rtk_GetFaxDisRxDetect</a>(i, &amp;dis); </div>
<div class="line">        <span class="keywordflow">if</span> (dis == 1)</div>
<div class="line">        {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Get FAX DIS RX event, ch=%d\n&quot;</span>, i);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/****************************************/</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (val)</div>
<div class="line">        {</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY1:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY2:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY3:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY4:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY5:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY6:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY7:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY8:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY9:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_KEY0:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_STAR:</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_HASH:</div>
<div class="line">            <span class="keywordflow">if</span> (channel-&gt;state == STATE_IDLE)</div>
<div class="line">            {</div>
<div class="line">                channel_handle_input(channel, val);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_ONHOOK:</div>
<div class="line">            channel_handle_onhook(channel);</div>
<div class="line">            <a name="a116"></a><a class="code" href="group__TAPI__PHONE__MISC.html#ga11966890f2e1cacc13e3f525758d2636" title="OnHook Action function. Call this TAPI always when On-Hook event is got.">rtk_OnHookAction</a>(i);    <span class="comment">// rtk_OnHookAction have to be the last step in SIGN_ONHOOK</span></div>
<div class="line">            fax_clear[i] = 1;</div>
<div class="line">            fax_end_clear[i] = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_OFFHOOK:</div>
<div class="line">            <a name="a117"></a><a class="code" href="group__TAPI__PHONE__MISC.html#gad0fba4da59d7db9bb24f88ca30c2ad34" title="OffHook Action function. Call this TAPI always when Off-Hook event is got.">rtk_OffHookAction</a>(i);   <span class="comment">// rtk_OffHookAction have to be the first step in SIGN_OFFHOOK</span></div>
<div class="line">            channel_handle_offhook(channel);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_RING_ON:      <span class="comment">// virtual daa ring on</span></div>
<div class="line">            <span class="keywordflow">if</span> (channel-&gt;state == STATE_IDLE)</div>
<div class="line">            {</div>
<div class="line">                channel-&gt;state = STATE_DAA_RING;</div>
<div class="line">                <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>(channel-&gt;chid, 1);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_RING_OFF:     <span class="comment">// virtual daa ring off</span></div>
<div class="line">            <span class="keywordflow">if</span> (channel-&gt;state == STATE_DAA_RING)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="group__TAPI__PHONE__FXS.html#ga78c7d0b71eb6062d169bb7231603d64f" title="Enable/Diable FXS Ringing.">rtk_SetRingFxs</a>(channel-&gt;chid, 0);</div>
<div class="line">                channel-&gt;state = STATE_IDLE;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_FLASHHOOK:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_OFFHOOK_2: <span class="comment">// off-hook but no event</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SIGN_NONE:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            printf(<span class="stringliteral">&quot;unknown(%d)\n&quot;</span>, val);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        usleep(100000 / CON_CH_NUM); <span class="comment">// 100ms</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">goto</span> main_loop;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 3 2014 11:37:43 for VoIP Interface by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
